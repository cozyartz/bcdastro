---
import AuthForm from '../../components/AuthForm.tsx';
import { getSession } from '../../lib/auth.ts';
import '../../styles/global.css';

const { id } = Astro.params;
const session = await getSession(Astro.request);
const media = await Astro.locals.D1.prepare('SELECT title, preview_url, type FROM media WHERE id = ?').bind(id).first();

if (!media) {
  return Astro.redirect('/404');
}

const purchased = session?.userId
  ? await Astro.locals.D1.prepare('SELECT * FROM purchases WHERE user_id = ? AND media_id = ?').bind(session.userId, id).first()
  : null;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{media.title} | BCDAstro</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="bg-gradient-to-br from-gray-950 to-black text-white font-sans min-h-screen">
    <main class="w-full max-w-4xl mx-auto px-4 py-16">
      <h1 class="text-4xl font-bold mb-8 text-center">{media.title}</h1>

      <div class="rounded-lg overflow-hidden shadow-lg mb-8">
        {media.type === 'image' ? (
          <img src={media.preview_url} alt={media.title} class="w-full h-auto object-cover rounded" />
        ) : (
          <video src={media.preview_url} controls class="w-full rounded" />
        )}
      </div>

      {session ? (
        purchased ? (
          <div class="text-center">
            <a href={`/media/download/${id}`} class="inline-block bg-green-600 text-white px-6 py-3 rounded-full btn-primary">Download</a>
          </div>
        ) : (
          <p class="text-center text-gray-300">Purchase required to download.</p>
        )
      ) : (
        <div class="mt-8">
          <AuthForm client:load />
        </div>
      )}
    </main>
  </body>
</html>
