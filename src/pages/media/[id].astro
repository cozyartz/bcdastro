---
import AuthForm from '../../components/AuthForm.tsx';
import { getSession } from '../../lib/auth';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SEO from '../../components/SEO.astro';
import '../../styles/global.css';

const { id } = Astro.params;
const session = await getSession(Astro.request);

const media = await Astro.locals.D1.prepare('SELECT title, preview_url, type FROM media WHERE id = ?')
  .bind(id)
  .first();

if (!media) {
  return Astro.redirect('/404');
}

const purchased = session?.userId
  ? await Astro.locals.D1.prepare(
      'SELECT * FROM purchases WHERE user_id = ? AND media_id = ?'
    )
      .bind(session.userId, id)
      .first()
  : null;
---

<html lang="en">
  <SEO title={`${media.title} | BCDAstro`} description={`Preview and purchase ${media.title} from Battle Creek Drone.`} />
  <body class="bg-gradient-to-br from-gray-950 to-black text-white font-sans overflow-x-hidden min-h-screen">
    <Header />

    <main class="pt-32 px-4 max-w-4xl mx-auto space-y-12">
      <section class="space-y-6 text-center">
        <h1 class="text-4xl font-bold animate-fade-in">{media.title}</h1>

        <div class="rounded-xl overflow-hidden shadow-2xl">
          {media.type === 'image' ? (
            <img src={media.preview_url} alt={media.title} class="w-full h-auto object-cover" />
          ) : (
            <video src={media.preview_url} controls class="w-full rounded" />
          )}
        </div>
      </section>

      <section class="text-center">
        {session ? (
          purchased ? (
            <a
              href={`/media/download/${id}`}
              class="inline-block bg-green-600 text-white px-6 py-3 rounded-full btn-primary hover:bg-green-700"
            >
              Download Now
            </a>
          ) : (
            <p class="text-gray-300">This media requires purchase to download.</p>
          )
        ) : (
          <div class="max-w-md mx-auto mt-10">
            <p class="mb-4 text-gray-400">Log in to access and purchase this media:</p>
            <AuthForm client:load />
          </div>
        )}
      </section>
    </main>

    <Footer />
  </body>
</html>
